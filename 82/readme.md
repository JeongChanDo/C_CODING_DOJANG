# C언어로 파일 아카이브 구현하기

파일 아카이브 : 파일안에 파일을 보관하는 방식으로 매우 광범위 하게 사용됨.

## 대표적인 아카이브 포맷
- 압축 파일 : zip, rar 등 파일 안에 다른 파일을 압축하여 보관.
- 테이프 아카이브 파일 : tar는 유닉스/리눅스 명령어로 여러 파일을 하나로 묶어줌. 단 압축을 하지 않음. 오래전 자기 테이프를 쓰던 시절부터 있었던 포멧이라 테이프 아카이브(tape archive)라 부름
- 게임 데이터 파일 : 파일 아카이브 포멧은 주로 게임에 사용 됩니다. 게임은 텍스처(그림), 3D 모델, 사운드 파일 등으로 이루어져 보통 몇백에서 많으면 수십만 개에 이르기도 합니다. 이렇게 많은 파일을 운영체제에 그대로 설치해서 실행하다보면 성능이 잘 나오지 않습니다. 왜냐면 운영체제에서 파일을 열고, 읽는 작업은 생각보다 부하가 크기 때문입니다. 따라서 수많은 파일을 하나로 묶어서 아카이브로 만들면 파일을 여는 동작을 한번만 하면 되고, 이후 부터는 포인터를 이동 시키면서 읽기만 하면 되기 때문에 성능이 향상 됩니다.
   - MAQ : Mo'PaQ의 약자로 블리자드에서 만든 게임에서 사용되는 파일 아카이브 포맷.

zip, tar, MPQ와 같이 역사가 깊고 범용적으로 쓰이는 포맷을 그대로 구현하기는 쉽지 않습니다.

이러한 포맷들은 다양한 요구사항을 만족해야하고 성능도 뛰어나야 하기 때문에 구조가 복잡하고 여러 최적화 방법들이 들어가 있습니다. 따라서 이번 예제어슨ㄴ 다음과 같은 기능을 간단한 방식으로 구현해보겠습니다.
- 아카이브 파일에 새 파일 추가
- 아카이브 파일에 들어있는 파일 출력
- 아카이브 파일에 들어있는 파일을 추출하여 새 파일로 저장(extract)

이번 예제는 길고 복잡합니다.
 특히 파일 처리 함수의 동작과 파일 포인터 위치를 눈여겨보는것이 좋습니다.

 ## 파일 포멧 설계하기

 파일 안에 여러개 파일을 저장하려면 어떻게 해야할까요? 다음과 같이 파일 내용을 연달아 저장하면 됩니다.

#### 아카이브 파일 저장 방식
 |아카이브파일|파일1|파일2|파일3|
 |---------|---|----|----|

 하지만 파일 내용만 연달아서 저장하면 어떤 파일이 저장되어 있고, 어느 위치에 저장되어있는지 알기 힘듭니다.
따라서 아카이브 파일 안에는 필요한 정보를 함께 저장해야 합니다. 그러면 어떤 정보를 저장하는 것이 좋을까요.

여러 요구사항을 만족하기 위해서 다양한 정보를 저장해야겠지만 필수적인 정보로 파일 이름, 파일 크기, 파일 데이터의 위치입니다. 그리고 아카이브 파일이 맞는지 확인하기 위한 매직 넘버와 파일 버전도 필요합니다.

#### 아카이브 파일의 구조
|--아카이브헤더--|-------------파일1--------------|---------------파일2--------------|
|-------------|-------------------------------|-------------------------------|

|매직넘버|파일버전|파일이름|파일크기|파일데이터위치|파일데이터|파일이름|파일크기|파일데이터위치|파일데이터|
|------|------|-----|------|----------|-------|------|------|----------|------|


바이너리 형식으로 된 파일은 파일 구조가 조금이라도 바뀌면 사용이 힘들어 집니다. 왜냐면 1바이트로 어긋나면 완전히 다른 정보를 읽게 되기 때문입니다. 그래서 보통 바이너리 형식으로 된 파일은 파일(포맷) 버전을 함께 저장하고, 파일 버전이 맞을 때만 처리하도록 구현합니다. 특히 버전간 호환성을 유지하면서 바이너리 파일의 구조를 설계하는 것은 쉽지 않은 일입니다.

## 82.2 아카이브 파일 구조체 작성하기

아카이브 파일의 구조를 설계했으니 구조체를 작성해보겠습니다. 먼저 아카이브 헤더입니다. 다음과 같이 헤더에는 아카이브 파일의 매직 넘버와 파일 버전이 들어갑니다. 여기서는 각 멤버의 크기를 정확하게 표현할 수 있는 헤더 파일의 자료형을 사용하겠습니다.

``` c
//아카이브 파일에 저장되는 구조체
typedef struct _ARCHIVE_HEADER {
   uint16_t magic;
   uint16_t version;
} ARCHIVE_HEADER, *PARCHIVE_HEADER;
```
이번에는 파일 정보(file descriptor) 구조체 입니다. 파일 이름 문자열과 파일 크기, 파일 데이터의 위치가 들어갑니다. 여기서 파일 데이터의 위치는 아카이브 파일 안에서 해당 파일의 데이터가 있는 곳의 시작 위치를 저장하게 됩니다.

``` c
typedef struct _FILE_DESC {
   char     name[256];
   uint32_t size;
   uint32_t dataOffset;
} FILE_DESC, *PFILE_DESC;
```
ARCHIVE_HEADER, FILE_DESC 구조체는 자료형 크기 그대로 저장되어야 하므로
#pragma pack(push, 1), #pragma pack(pop)을 사용하여 1바이트 크기로 정렬해 줍시다.

